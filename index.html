// Track selection
let selectedNode = null;

gNodes.addEventListener('click', e=>{
  const g=e.target.closest('g[data-id]');
  if(!g) return;
  const id=g.getAttribute('data-id');
  selectedNode = { id, level: currentLevel };
  if(currentLevel==='overview') showSubsteps(id);
});

// Make text editable
function makeEditable(el, callback) {
  el.setAttribute('contentEditable', true);
  el.addEventListener('blur', () => {
    callback(el.textContent);
  });
}

// Example: let labels be editable
function enableEditing() {
  gNodes.querySelectorAll('.label, .subtext').forEach(el=>{
    makeEditable(el, newText=>{
      // update milestones data when text changes
      const g = el.closest('g');
      const id = g.getAttribute('data-id');
      if(currentLevel==='overview'){
        const m = milestones.find(x=>x.id===id);
        if(m) m.title = newText;
      } else {
        const m = milestones.find(x=>x.id===currentLevel);
        if(m){
          const idx = m.substeps.indexOf(el.textContent);
          if(idx>-1) m.substeps[idx] = newText;
        }
      }
    });
  });
}

// Hook into draw functions
function drawFlow(items){ 
  // ...existing code...
  enableEditing(); // <— at the end
}
function showSubsteps(id){ 
  // ...existing code...
  enableEditing(); // <— at the end
}

// Add buttons
document.getElementById('addMilestone').addEventListener('click',()=>{
  const newId = 'milestone_'+Date.now();
  milestones.push({ id:newId, title:'New Milestone', substeps:['Step 1'] });
  showOverview();
});
document.getElementById('addSubstep').addEventListener('click',()=>{
  if(currentLevel!=='overview'){
    const m=milestones.find(x=>x.id===currentLevel);
    if(m){
      m.substeps.push('New Step');
      showSubsteps(m.id);
    }
  }
});
document.getElementById('deleteSelected').addEventListener('click',()=>{
  if(!selectedNode) return;
  if(selectedNode.level==='overview'){
    const idx=milestones.findIndex(x=>x.id===selectedNode.id);
    if(idx>-1){milestones.splice(idx,1);showOverview();}
  } else {
    const m=milestones.find(x=>x.id===currentLevel);
    if(m){
      m.substeps=m.substeps.filter(s=>s!==selectedNode.id);
      showSubsteps(m.id);
    }
  }
  selectedNode=null;
});
document.getElementById('exportJSON').addEventListener('click',()=>{
  const dataStr="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(milestones,null,2));
  const a=document.createElement('a');
  a.setAttribute("href",dataStr);
  a.setAttribute("download","process.json");
  a.click();
});
