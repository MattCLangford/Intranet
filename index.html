<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wise Productions — Critical Client Flow (Dataverse Editor)</title>
<style>
  :root{
    --paper:#fdfdfc;
    --navy:#192a56;
    --rose:#9e768f;
    --text:#333;
    --edge:#555;
    --ring:#b6c1ff;
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:var(--paper);color:var(--text);
    font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
  }
  header{
    position:sticky;top:0;z-index:10;display:flex;gap:.75rem;flex-wrap:wrap;align-items:center;
    padding:.8rem 1rem;border-bottom:1px solid #ddd;background:var(--paper)
  }
  .title{font-weight:700;font-size:1.15rem;color:var(--navy);margin-right:auto}
  .btn{appearance:none;border:1px solid #cfd3da;background:#fff;color:#111;padding:.5rem .8rem;border-radius:8px;cursor:pointer}
  .btn.primary{background:var(--navy);color:#fff;border-color:var(--navy)}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .canvas{position:relative;height:calc(100vh - 66px);overflow:auto}
  svg{width:2200px;height:4000px;display:block}
  .node rect{stroke:none;rx:28;ry:28;filter:drop-shadow(0 4px 8px rgba(0,0,0,.12))}
  .label{
    font-size:24px;
    fill:#fff;
    font-weight:700;
    pointer-events:auto;   /* now clickable */
    cursor:text;
    text-anchor:middle;
    dominant-baseline:middle
  }
  .sub{
    font-size:14px;
    fill:#f1f5f9;
    pointer-events:auto;   /* now clickable */
    cursor:text;
    text-anchor:middle;
    dominant-baseline:hanging
  }
  .edge{stroke:var(--edge);stroke-width:2.2;fill:none;marker-end:url(#arrow)}
  .selected rect{outline:3px solid var(--ring)}
  .linking rect{outline:3px dashed #88b}
  .ghost rect{opacity:.6;stroke-dasharray:6 6;stroke:#bbb;stroke-width:2}
  .toolbar{display:flex;gap:.5rem;flex-wrap:wrap}
  .stat{font-size:.85rem;color:#666}
</style>
</head>
<body>
<header>
  <div class="title">Wise Productions — Critical Client Flow (Dataverse Editor)</div>
  <div class="toolbar">
    <button class="btn primary" id="addMilestone">+ Milestone</button>
    <button class="btn" id="addSubstep">+ Substep</button>
    <button class="btn" id="linkModeBtn">Link Steps</button>
    <button class="btn" id="deleteBtn">− Delete</button>
    <button class="btn" id="saveAllBtn">Save All</button>
  </div>
  <div class="toolbar">
    <button class="btn" id="exportBtn">Export JSON</button>
    <label class="btn" for="importInput" style="cursor:pointer">Import JSON</label>
    <input id="importInput" type="file" accept="application/json" style="display:none">
    <button class="btn" id="loadLocalBtn">Load Local</button>
    <button class="btn" id="clearLocalBtn">Clear Local</button>
  </div>
  <div class="stat" id="status">Ready</div>
</header>

<div class="canvas" id="canvas">
  <svg id="svg" viewBox="0 0 2200 4000" preserveAspectRatio="xMidYMin">
    <defs>
      <marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8" markerHeight="8" orient="auto">
        <path d="M0 0 L10 5 L0 10 z" fill="#555"></path>
      </marker>
      <!-- Navy → Rose gradient set -->
      <linearGradient id="grad0" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="#192a56"/><stop offset="100%" stop-color="#2e3c6a"/>
      </linearGradient>
      <linearGradient id="grad1" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="#2e3c6a"/><stop offset="100%" stop-color="#4c4d77"/>
      </linearGradient>
      <linearGradient id="grad2" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="#4c4d77"/><stop offset="100%" stop-color="#6b5c7e"/>
      </linearGradient>
      <linearGradient id="grad3" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="#6b5c7e"/><stop offset="100%" stop-color="#876683"/>
      </linearGradient>
      <linearGradient id="grad4" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="#876683"/><stop offset="100%" stop-color="#9e768f"/>
      </linearGradient>
    </defs>
    <g id="edges"></g>
    <g id="nodes"></g>
  </svg>
</div>

<script>
/* ------------------ Dataverse config trimmed for brevity ------------------ */
function uid(){ return 'id_'+crypto.randomUUID(); }
const Types = { Milestone:0, Substep:1 };
function gradForIndex(i){ return `url(#grad${Math.min(i%5,4)})`; }

let model={ nodes:[
  {id:uid(),title:'Enquiry',type:Types.Milestone,x:200,y:120,next:[]},
  {id:uid(),title:'Qualification',type:Types.Milestone,x:200,y:320,next:[]}
]};

const svg=document.getElementById('svg');
const gNodes=document.getElementById('nodes');
const gEdges=document.getElementById('edges');
let selectedId=null;

function nodeW(n){ return n.type===Types.Milestone?420:320; }
function nodeH(n){ return n.type===Types.Milestone?160:120; }

function render(){
  gNodes.innerHTML=''; gEdges.innerHTML='';
  for(const n of model.nodes){
    if(!n.next) continue;
    for(const tid of n.next){
      const t=model.nodes.find(x=>x.id===tid); if(t) drawEdge(n,t);
    }
  }
  model.nodes.forEach((n,i)=>drawNode(n,i));
}
function drawEdge(a,b){
  const ax=a.x+nodeW(a)/2, ay=a.y+nodeH(a)/2;
  const bx=b.x+nodeW(b)/2, by=b.y+nodeH(b)/2;
  const p=document.createElementNS('http://www.w3.org/2000/svg','path');
  p.setAttribute('class','edge');
  p.setAttribute('d',`M ${ax} ${ay} L ${bx} ${by}`);
  gEdges.appendChild(p);
}
function drawNode(n,i){
  const g=document.createElementNS('http://www.w3.org/2000/svg','g');
  g.setAttribute('data-id',n.id);
  g.setAttribute('class','node');

  const r=document.createElementNS('http://www.w3.org/2000/svg','rect');
  r.setAttribute('x',n.x); r.setAttribute('y',n.y);
  r.setAttribute('width',nodeW(n)); r.setAttribute('height',nodeH(n));
  r.setAttribute('fill',gradForIndex(i));
  g.appendChild(r);

  const t=document.createElementNS('http://www.w3.org/2000/svg','text');
  t.setAttribute('x',n.x+nodeW(n)/2);
  t.setAttribute('y',n.y+nodeH(n)/2);
  t.setAttribute('class','label');
  t.textContent=n.title;
  g.appendChild(t);

  gNodes.appendChild(g);

  // enable dblclick on both rect and text
  [r,t].forEach(el=>{
    el.addEventListener('dblclick',(e)=>{
      e.stopPropagation();
      inlineEdit(n);
    });
  });
}
function svgToClient(x,y){
  const pt=svg.createSVGPoint(); pt.x=x; pt.y=y;
  const ctm=svg.getScreenCTM();
  const p=pt.matrixTransform(ctm);
  return {x:p.x,y:p.y};
}
function inlineEdit(node){
  const bbox={x:node.x,y:node.y,w:nodeW(node),h:nodeH(node)};
  const center=svgToClient(bbox.x+bbox.w/2,bbox.y+bbox.h/2);
  const input=document.createElement('input');
  input.type='text'; input.value=node.title||'';
  input.style.position='fixed';
  input.style.left=(center.x-180)+'px';
  input.style.top=(center.y-15)+'px';
  input.style.width='360px';
  input.style.padding='6px 8px';
  input.style.border='1px solid #cfd3da';
  input.style.borderRadius='8px';
  input.style.zIndex=9999;
  input.style.font='16px system-ui';
  document.body.appendChild(input);
  input.focus(); input.select();
  function commit(){
    node.title=input.value.trim()||node.title;
    document.body.removeChild(input);
    render();
  }
  input.addEventListener('keydown',e=>{
    if(e.key==='Enter') commit();
    if(e.key==='Escape') document.body.removeChild(input);
  });
  input.addEventListener('blur',commit);
}
render();
</script>
</body>
</html>
