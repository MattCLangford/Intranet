<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Critical Client Flow — Editor</title>
  <style>
    :root {
      color-scheme: light;
      --navy: #192a56;
      --navy-dark: #101d3d;
      --rose: #f8f0ff;
      --surface: #ffffff;
      --border: #e0e4ef;
      --ink: #1f2933;
      --muted: #61708b;
      --editor-fr: 55fr;
      --preview-fr: 45fr;
      --editor-scale: 1;
      --preview-scale: 1;
    }

    html {
      font-size: 67%;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: linear-gradient(180deg, #f4f6fb 0%, #eef1f8 100%);
      color: var(--ink);
      font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      font-size: 1rem;
      line-height: 1.5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: .9rem clamp(1rem, 2vw, 1.5rem);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: .75rem;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 20;
    }

    header h1 {
      font-size: clamp(1.05rem, 1.4vw, 1.25rem);
      margin: 0;
      color: var(--navy);
      letter-spacing: -.01em;
    }

    header p {
      margin: 0;
      color: var(--muted);
      font-size: .7rem;
    }

    .layout-controls {
      display: flex;
      align-items: center;
      gap: .45rem;
      font-size: .65rem;
      color: var(--muted);
      background: rgba(25, 42, 86, 0.06);
      padding: .5rem .7rem;
      border-radius: 999px;
      border: 1px solid rgba(25, 42, 86, 0.08);
      flex-wrap: wrap;
    }

    .layout-controls .control-group {
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      background: rgba(255, 255, 255, .4);
      padding: .25rem .5rem;
      border-radius: 999px;
    }

    .layout-controls .control-group label {
      font-weight: 600;
      color: var(--navy);
      font-size: .6rem;
      text-transform: uppercase;
      letter-spacing: .06em;
      white-space: nowrap;
    }

    .layout-controls input[type="range"] {
      accent-color: var(--navy);
      width: 120px;
    }

    .layout-controls .control-group span {
      font-variant-numeric: tabular-nums;
      color: var(--muted);
    }

    .layout-controls button {
      font-size: .65rem;
      padding: .35rem .55rem;
      border-radius: 12px;
    }

    main {
      flex: 1;
      padding: clamp(.75rem, 1.5vw, 1.75rem);
      display: grid;
      gap: clamp(1.1rem, 1.5vw, 1.75rem);
      grid-template-columns: minmax(320px, var(--editor-fr)) minmax(320px, var(--preview-fr));
      align-items: start;
    }

    .panel {
      background: var(--surface);
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 10px 24px -24px rgba(26, 34, 56, 0.4);
      padding: clamp(.75rem, 1.2vw, 1.3rem);
      max-height: calc(100vh - 160px);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .panel h2 {
      margin: 0 0 .75rem;
      font-size: .9rem;
      color: var(--navy);
    }

    .scroll {
      overflow: auto;
      padding-right: .25rem;
      flex: 1;
    }

    .scaled {
      transform-origin: top left;
    }

    .editor-scaled {
      transform: scale(var(--editor-scale));
    }

    .preview-scaled {
      transform: scale(var(--preview-scale));
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: .55rem;
      margin-bottom: .75rem;
    }

    button, .ghost-btn {
      appearance: none;
      border: none;
      border-radius: 8px;
      padding: .4rem .7rem;
      font: inherit;
      font-weight: 600;
      cursor: pointer;
      transition: transform .12s ease, box-shadow .12s ease;
      display: inline-flex;
      align-items: center;
      gap: .45rem;
      color: var(--surface);
      background: var(--navy);
      box-shadow: 0 6px 18px -10px rgba(25, 42, 86, .7);
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px -14px rgba(25, 42, 86, .7);
    }

    button:disabled {
      cursor: not-allowed;
      opacity: .5;
      box-shadow: none;
    }

    .ghost-btn {
      background: transparent;
      border: 1px solid rgba(25, 42, 86, .18);
      color: var(--navy);
      box-shadow: none;
    }

    .editor-node {
      background: rgba(25, 42, 86, 0.04);
      border: 1px solid rgba(25, 42, 86, 0.1);
      border-radius: 10px;
      padding: .75rem;
      margin-bottom: .75rem;
      position: relative;
    }

    .editor-node::before {
      content: attr(data-label);
      position: absolute;
      top: -10px;
      left: 12px;
      background: var(--navy);
      color: #fff;
      font-size: .55rem;
      padding: .08rem .4rem;
      border-radius: 999px;
      letter-spacing: .06em;
      text-transform: uppercase;
    }

    .editor-node.depth-1::before { content: "Milestone"; }
    .editor-node.depth-2::before { content: "Sub Stage"; }
    .editor-node.depth-3::before { content: "Step"; }
    .editor-node.depth-4::before { content: "Detail"; }
    .editor-node.depth-5::before { content: "Sub Detail"; }
    .editor-node.depth-6::before { content: "Micro Step"; }

    .node-fields {
      display: grid;
      gap: .55rem;
    }

    label {
      display: flex;
      flex-direction: column;
      font-size: .6rem;
      color: var(--muted);
      gap: .35rem;
    }

    input[type="text"], textarea {
      font: inherit;
      border-radius: 10px;
      border: 1px solid rgba(25, 42, 86, 0.18);
      padding: .4rem .5rem;
      width: 100%;
      resize: vertical;
      background: #fff;
    }

    textarea {
      min-height: 54px;
    }

    .node-actions {
      display: flex;
      flex-wrap: wrap;
      gap: .35rem;
    }

    .node-children {
      margin-top: .75rem;
      padding-left: .75rem;
      border-left: 3px solid rgba(25, 42, 86, 0.15);
      display: grid;
      gap: .75rem;
    }

    .info {
      background: rgba(25, 42, 86, .08);
      border-radius: 10px;
      padding: .75rem;
      color: var(--navy-dark);
      font-size: .62rem;
      margin-bottom: .75rem;
    }

    .preview {
      counter-reset: milestone;
      display: grid;
      gap: .9rem;
    }

    .preview-card {
      background: linear-gradient(135deg, rgba(25, 42, 86, 0.95), rgba(78, 106, 168, 0.9));
      border-radius: 15px;
      padding: 1.125rem;
      color: #f9fbff;
      box-shadow: 0 14px 30px -22px rgba(8, 15, 45, 0.9);
      position: relative;
    }

    .preview-card h3 {
      margin: 0 0 .35rem;
      font-size: .95rem;
      letter-spacing: -.01em;
    }

    .preview-card p {
      margin: 0 0 .75rem;
      color: rgba(245, 248, 255, .82);
      font-size: .7rem;
    }

    .preview-card::before {
      counter-increment: milestone;
      content: counter(milestone);
      position: absolute;
      top: -12px;
      right: 12px;
      background: rgba(255, 255, 255, .1);
      width: 36px;
      height: 36px;
      border-radius: 12px;
      display: grid;
      place-items: center;
      font-weight: 700;
      font-size: .8rem;
    }

    .preview-children {
      margin-top: .75rem;
      border-left: 2px dashed rgba(255, 255, 255, .3);
      padding-left: .9rem;
      display: grid;
      gap: .75rem;
    }

    .preview-children .preview-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.15));
      color: #fff;
      box-shadow: none;
    }

    .status {
      margin-top: .55rem;
      font-size: .65rem;
      color: var(--muted);
      min-height: 1.2rem;
    }

    .status.success { color: #107869; }
    .status.error { color: #c81e38; }

    .hidden-input {
      display: none;
    }

    .hidden {
      display: none !important;
    }

    body.hide-help #editorHelp {
      display: none;
    }

    body.hide-help .toolbar {
      margin-top: 0;
    }

    body.hide-preview main {
      grid-template-columns: minmax(320px, 1fr);
    }

    body.hide-preview section[aria-labelledby="preview-heading"] {
      display: none;
    }

    body.hide-preview #previewInfo {
      display: none;
    }

    body.hide-editor main {
      grid-template-columns: minmax(320px, 1fr);
    }

    body.hide-editor section[aria-labelledby="editor-heading"] {
      display: none;
    }

    body.hide-editor.hide-preview main {
      grid-template-columns: minmax(320px, 1fr);
    }

    @media (max-width: 1024px) {
      header {
        justify-content: flex-start;
      }

      main {
        grid-template-columns: 1fr;
      }

      .panel {
        max-height: none;
      }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Critical Client Flow (CCF) — Editor</h1>
      <p>Design and maintain your milestones, sub stages, and deep-dive sub steps with full control.</p>
    </div>
    <div class="layout-controls">
      <div class="control-group" role="group" aria-label="Layout balance">
        <label for="panelSplit">Layout</label>
        <input type="range" id="panelSplit" min="30" max="70" value="55" />
        <span id="panelSplitValue">55% / 45%</span>
      </div>
      <div class="control-group" role="group" aria-label="Editor zoom">
        <label for="editorScale">Editor</label>
        <input type="range" id="editorScale" min="70" max="150" value="100" step="5" />
        <span id="editorScaleValue">100%</span>
      </div>
      <div class="control-group" role="group" aria-label="Preview zoom">
        <label for="previewScale">Preview</label>
        <input type="range" id="previewScale" min="70" max="150" value="100" step="5" />
        <span id="previewScaleValue">100%</span>
      </div>
      <button type="button" class="ghost-btn" id="toggleHelp" aria-pressed="false">❔ Hide Help</button>
      <button type="button" class="ghost-btn" id="toggleEditor" aria-pressed="false">🧩 Hide Editor</button>
      <button type="button" class="ghost-btn" id="togglePreview" aria-pressed="false">👁 Hide Preview</button>
    </div>
  </header>

  <main>
    <section class="panel" aria-labelledby="editor-heading">
      <div class="toolbar">
        <button type="button" id="addRoot">➕ Add Milestone</button>
        <button type="button" id="saveDataverse">💾 Save to Dataverse</button>
        <button type="button" class="ghost-btn" id="exportJson">⬇️ Export JSON</button>
        <button type="button" class="ghost-btn" id="importJson">⬆️ Import JSON</button>
        <input type="file" id="importFile" class="hidden-input" accept="application/json" />
      </div>
      <div class="info" id="editorHelp">
        <strong>How it works</strong>
        <ul>
          <li>Milestone is the highest level. Add nested sub stages and steps up to six layers deep.</li>
          <li>Click <em>Add Sub-step</em> inside any card to cascade deeper into the process.</li>
          <li>Use Move Up / Move Down to reorder items within the same level.</li>
          <li>Changes are auto-saved to your browser and can be exported or pushed to Dataverse.</li>
        </ul>
      </div>
      <h2 id="editor-heading">Structure</h2>
      <div class="scroll">
        <div id="editor" class="scaled editor-scaled"></div>
      </div>
      <div class="status" id="status"></div>
    </section>

    <section class="panel" aria-labelledby="preview-heading">
      <h2 id="preview-heading">Live Preview</h2>
      <p class="info" id="previewInfo" style="margin-top:0">This preview updates instantly, showing how clients experience your process across milestones and nested stages.</p>
      <div class="scroll">
        <div id="preview" class="preview scaled preview-scaled"></div>
      </div>
    </section>
  </main>

  <template id="emptyState">
    <div style="padding:2rem;text-align:center;color:var(--muted);">
      <p>No milestones yet. Start by adding one from the toolbar.</p>
    </div>
  </template>

  <script>
    const MAX_DEPTH = 6;
    const STORAGE_KEY = 'ccf-editor-data-v1';
    const PREFERENCES_KEY = 'ccf-editor-preferences-v1';
    const previewState = {
      expanded: new Set()
    };

    const defaultFlow = [
      {
        id: createId(),
        title: 'Initial Discovery',
        description: 'Understand the client, scope, and desired outcomes.',
        children: [
          {
            id: createId(),
            title: 'Intake Call',
            description: 'Gather baseline information and qualify the opportunity.',
            children: [
              {
                id: createId(),
                title: 'Prepare Call Agenda',
                description: 'Outline discovery prompts and confirm attendees.',
                children: []
              },
              {
                id: createId(),
                title: 'Conduct Discovery Session',
                description: 'Capture goals, constraints, and success metrics.',
                children: []
              }
            ]
          },
          {
            id: createId(),
            title: 'Needs Assessment',
            description: 'Translate discovery output into solution requirements.',
            children: []
          }
        ]
      },
      {
        id: createId(),
        title: 'Solution Design',
        description: 'Craft the recommended approach and validate it internally.',
        children: [
          {
            id: createId(),
            title: 'Storyboard Experience',
            description: 'Build an end-to-end walkthrough for the client journey.',
            children: []
          },
          {
            id: createId(),
            title: 'Internal Review',
            description: 'Stress-test logistics, staffing, and budget feasibility.',
            children: []
          }
        ]
      }
    ];

    function createId() {
      if (typeof crypto !== 'undefined' && crypto.randomUUID) {
        return crypto.randomUUID();
      }
      return 'id-' + Math.random().toString(36).slice(2, 9);
    }

    const editorEl = document.getElementById('editor');
    const previewEl = document.getElementById('preview');
    const statusEl = document.getElementById('status');
    const addRootBtn = document.getElementById('addRoot');
    const saveBtn = document.getElementById('saveDataverse');
    const exportBtn = document.getElementById('exportJson');
    const importBtn = document.getElementById('importJson');
    const importFileInput = document.getElementById('importFile');
    const emptyTemplate = document.getElementById('emptyState');

    const panelSplitInput = document.getElementById('panelSplit');
    const panelSplitValue = document.getElementById('panelSplitValue');
    const editorScaleInput = document.getElementById('editorScale');
    const editorScaleValue = document.getElementById('editorScaleValue');
    const previewScaleInput = document.getElementById('previewScale');
    const previewScaleValue = document.getElementById('previewScaleValue');

    let flow = loadFlow();

    renderAll();

    function loadFlow() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) return JSON.parse(stored);
      } catch (e) {
        console.warn('Failed to parse stored data', e);
      }
      return defaultFlow;
    }

    function persist() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(flow));
    }

    addRootBtn.addEventListener('click', () => {
      flow.push(createNode('New Milestone'));
      renderAll(true);
    });

    saveBtn.addEventListener('click', saveToDataverse);
    exportBtn.addEventListener('click', downloadJson);
    importBtn.addEventListener('click', () => importFileInput.click());
    importFileInput.addEventListener('change', handleImport);

    panelSplitInput.addEventListener('input', () => {
      updatePanelSplit(Number(panelSplitInput.value));
      persistPreferences();
    });

    editorScaleInput.addEventListener('input', () => {
      const scale = Number(editorScaleInput.value) / 100;
      document.documentElement.style.setProperty('--editor-scale', scale);
      editorScaleValue.textContent = `${editorScaleInput.value}%`;
      persistPreferences();
    });

    previewScaleInput.addEventListener('input', () => {
      const scale = Number(previewScaleInput.value) / 100;
      document.documentElement.style.setProperty('--preview-scale', scale);
      previewScaleValue.textContent = `${previewScaleInput.value}%`;
      persistPreferences();
    });

    const toggleHelpBtn = document.getElementById('toggleHelp');
    toggleHelpBtn.addEventListener('click', () => {
      document.body.classList.toggle('hide-help');
      toggleHelpBtn.textContent = document.body.classList.contains('hide-help') ? '❔ Show Help' : '❔ Hide Help';
    });

    const toggleEditorBtn = document.getElementById('toggleEditor');
    toggleEditorBtn.addEventListener('click', () => {
      document.body.classList.toggle('hide-editor');
      toggleEditorBtn.textContent = document.body.classList.contains('hide-editor') ? '🧩 Show Editor' : '🧩 Hide Editor';
    });

    const togglePreviewBtn = document.getElementById('togglePreview');
    togglePreviewBtn.addEventListener('click', () => {
      document.body.classList.toggle('hide-preview');
      togglePreviewBtn.textContent = document.body.classList.contains('hide-preview') ? '👁 Show Preview' : '👁 Hide Preview';
    });

    function createNode(title = 'New Item') {
      return {
        id: createId(),
        title,
        description: '',
        children: []
      };
    }

    function renderAll(force = false) {
      renderEditor();
      renderPreview();
      persist();
      if (force) {
        flashStatus('Updated.', 'success');
      }
    }

    function renderEditor() {
      editorEl.innerHTML = '';
      if (!flow.length) {
        editorEl.append(emptyTemplate.content.cloneNode(true));
        return;
      }
      flow.forEach((node, index) => {
        editorEl.appendChild(buildEditorNode(node, 1, flow, index));
      });
    }

    function buildEditorNode(node, depth, parentArray, index) {
      const wrapper = document.createElement('div');
      wrapper.className = `editor-node depth-${depth}`;
      wrapper.dataset.label = '';

      const fields = document.createElement('div');
      fields.className = 'node-fields';

      const titleLabel = document.createElement('label');
      titleLabel.textContent = 'Title';
      const titleInput = document.createElement('input');
      titleInput.type = 'text';
      titleInput.value = node.title;
      titleInput.addEventListener('input', () => {
        node.title = titleInput.value;
        renderPreview();
        persist();
      });
      titleLabel.appendChild(titleInput);

      const descriptionLabel = document.createElement('label');
      descriptionLabel.textContent = 'Description (optional)';
      const descriptionInput = document.createElement('textarea');
      descriptionInput.value = node.description || '';
      descriptionInput.placeholder = 'Add clarifying details, owners, or exit criteria.';
      descriptionInput.addEventListener('input', () => {
        node.description = descriptionInput.value;
        renderPreview();
        persist();
      });
      descriptionLabel.appendChild(descriptionInput);

      fields.append(titleLabel, descriptionLabel);

      const actions = document.createElement('div');
      actions.className = 'node-actions';

      const addChildBtn = document.createElement('button');
      addChildBtn.type = 'button';
      addChildBtn.textContent = '➕ Add Sub-step';
      addChildBtn.addEventListener('click', () => {
        node.children.push(createNode(`New ${depth >= 1 ? 'Sub-step' : 'Item'}`));
        previewState.expanded.add(node.id);
        renderAll(true);
      });
      if (depth >= MAX_DEPTH) {
        addChildBtn.disabled = true;
        addChildBtn.title = `Maximum depth of ${MAX_DEPTH} reached`;
      }

      const moveUpBtn = document.createElement('button');
      moveUpBtn.type = 'button';
      moveUpBtn.textContent = '⬆️ Move Up';
      moveUpBtn.addEventListener('click', () => {
        if (index > 0) {
          moveNode(parentArray, index, index - 1);
          renderAll();
        }
      });
      if (index === 0) moveUpBtn.disabled = true;

      const moveDownBtn = document.createElement('button');
      moveDownBtn.type = 'button';
      moveDownBtn.textContent = '⬇️ Move Down';
      moveDownBtn.addEventListener('click', () => {
        if (index < parentArray.length - 1) {
          moveNode(parentArray, index, index + 1);
          renderAll();
        }
      });
      if (index === parentArray.length - 1) moveDownBtn.disabled = true;

      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.textContent = '🗑️ Remove';
      deleteBtn.classList.add('ghost-btn');
      deleteBtn.addEventListener('click', () => {
        const shouldDelete = confirm('Remove this item and all nested steps?');
        if (shouldDelete) {
          collapseBranch(node);
          parentArray.splice(index, 1);
          renderAll(true);
        }
      });

      actions.append(addChildBtn, moveUpBtn, moveDownBtn, deleteBtn);
      fields.appendChild(actions);

      wrapper.appendChild(fields);

      if (node.children && node.children.length) {
        const childrenContainer = document.createElement('div');
        childrenContainer.className = 'node-children';
        node.children.forEach((child, childIndex) => {
          childrenContainer.appendChild(buildEditorNode(child, depth + 1, node.children, childIndex));
        });
        wrapper.appendChild(childrenContainer);
      }

      return wrapper;
    }

    function moveNode(array, fromIndex, toIndex) {
      const item = array.splice(fromIndex, 1)[0];
      array.splice(toIndex, 0, item);
    }

    function renderPreview() {
      previewEl.innerHTML = '';
      if (!flow.length) {
        previewEl.append(emptyTemplate.content.cloneNode(true));
        return;
      }
      flow.forEach((node, index) => {
        previewEl.appendChild(buildPreviewNode(node, 1, `${index + 1}`));
      });
    }

    function buildPreviewNode(node, depth, numbering) {
      const card = document.createElement('article');
      card.className = `preview-card depth-${depth}`;

      const hasChildren = node.children && node.children.length;
      const isExpanded = hasChildren && previewState.expanded.has(node.id);
      if (hasChildren && !isExpanded) {
        card.classList.add('collapsed');
      }
      if (hasChildren && isExpanded) {
        card.classList.add('expanded');
      }

      const header = document.createElement('div');
      header.className = 'preview-card-header';

      const title = document.createElement('h3');
      title.textContent = numbering ? `${numbering} — ${node.title}` : node.title;
      header.appendChild(title);

      if (hasChildren) {
        const meta = document.createElement('div');
        meta.className = 'preview-meta';

        const count = document.createElement('span');
        count.className = 'preview-count';
        const label = depth === 1 ? 'sub stage' : 'step';
        const total = node.children.length;
        count.textContent = `${total} ${label}${total !== 1 ? 's' : ''}`;
        meta.appendChild(count);

        const toggle = document.createElement('button');
        toggle.type = 'button';
        toggle.className = 'preview-toggle';
        toggle.textContent = isExpanded ? 'Hide details' : 'Show details';
        toggle.addEventListener('click', event => {
          event.stopPropagation();
          togglePreviewNode(node.id);
        });
        meta.appendChild(toggle);
        header.appendChild(meta);

        if (!isExpanded) {
          card.addEventListener('click', () => {
            togglePreviewNode(node.id);
          });
        }
      }

      card.appendChild(header);

      if (node.description) {
        const description = document.createElement('p');
        description.textContent = node.description;
        card.appendChild(description);
      }

      if (hasChildren && isExpanded) {
        const childWrapper = document.createElement('div');
        childWrapper.className = 'preview-children';
        node.children.forEach((child, index) => {
          const childNumber = numbering ? `${numbering}.${index + 1}` : `${index + 1}`;
          childWrapper.appendChild(buildPreviewNode(child, depth + 1, childNumber));
        });
        card.appendChild(childWrapper);
      }

      return card;
    }

    async function saveToDataverse() {
      const payload = {
        name: 'Critical Client Flow',
        updatedAt: new Date().toISOString(),
        milestones: flow
      };

      flashStatus('Saving to Dataverse…', '');
      try {
        if (window.DATAVERSE_ENDPOINT) {
          const response = await fetch(window.DATAVERSE_ENDPOINT, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
          });
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
        } else {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(flow));
        }
        flashStatus('Saved successfully. Dataverse payload ready.', 'success');
      } catch (error) {
        console.error(error);
        flashStatus('Failed to save. Check the console for details.', 'error');
      }
    }

    function downloadJson() {
      const payload = {
        exportedAt: new Date().toISOString(),
        milestones: flow
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'critical-client-flow.json';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      flashStatus('Exported JSON downloaded.', 'success');
    }

    async function handleImport(event) {
      const file = event.target.files?.[0];
      if (!file) return;
      try {
        const text = await file.text();
        const parsed = JSON.parse(text);
        if (!parsed || !Array.isArray(parsed.milestones || parsed)) {
          throw new Error('Invalid structure. Expecting { milestones: [] } or an array.');
        }
        flow = Array.isArray(parsed) ? parsed : parsed.milestones;
        previewState.expanded.clear();
        normalizeIds(flow);
        renderAll(true);
        flashStatus('JSON imported successfully.', 'success');
      } catch (error) {
        console.error('Import failed', error);
        flashStatus('Import failed. Please verify the file format.', 'error');
      } finally {
        importFileInput.value = '';
      }
    }

    function normalizeIds(nodes) {
      nodes.forEach(node => {
        if (!node.id) node.id = createId();
        if (!node.children) node.children = [];
        if (Array.isArray(node.children)) {
          normalizeIds(node.children);
        }
      });
    }

    function collapseBranch(node) {
      previewState.expanded.delete(node.id);
      if (node.children) {
        node.children.forEach(child => collapseBranch(child));
      }
    }

    function togglePreviewNode(id) {
      if (previewState.expanded.has(id)) {
        previewState.expanded.delete(id);
      } else {
        previewState.expanded.add(id);
      }
      renderPreview();
    }

    function updatePanelSplit(value) {
      if (!Number.isFinite(value)) return;
      const clamped = Math.min(70, Math.max(30, value));
      const previewShare = 100 - clamped;
      document.documentElement.style.setProperty('--editor-fr', `${clamped}fr`);
      document.documentElement.style.setProperty('--preview-fr', `${previewShare}fr`);
      if (panelSplitValue) {
        panelSplitValue.textContent = `${clamped}% / ${previewShare}%`;
      }
    }

    function persistPreferences() {
      const prefs = {
        panelSplit: Number(panelSplitInput.value),
        editorScale: Number(editorScaleInput.value),
        previewScale: Number(previewScaleInput.value)
      };
      localStorage.setItem(PREFERENCES_KEY, JSON.stringify(prefs));
    }

    function flashStatus(message, type) {
      statusEl.textContent = message;
      statusEl.className = `status ${type}`.trim();
      if (message) {
        setTimeout(() => {
          if (statusEl.textContent === message) {
            statusEl.textContent = '';
            statusEl.className = 'status';
          }
        }, 4000);
      }
    }
  </script>
</body>
</html>